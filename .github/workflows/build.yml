name: Build nori-bridge-head

on:
  pull_request:
    types: [closed]
    branches:
      - build

jobs:
  build-nori-bridge-head:
    name: Build nori-bridge-head is a REN release, based on a pull request close (merge=true) event, with the branch 'build' as the PR target.
    if: github.event.pull_request.merged == true
    runs-on: [self-hosted, nori, standard]
    permissions:
      contents: read
      pull-requests: write
    container:
      image: docker.nori.it.com/stacksmith:1.0.0
      volumes:
        # SSH for git operations
        - /home/runner/.ssh:/root/.ssh:ro

        # Stacksmith envs (used to enable specific pipelines which need env vars)
        - /home/runner/.stacksmith.envs:/root/.stacksmith.envs:ro

        # This makes the path consistent across parent and sibling containers
        - /tmp/stacksmith_repos:/tmp/stacksmith_repos

    timeout-minutes: 180

    steps:
      - name: Comment on PR - Build Started
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISPATCH_TOKEN }}
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const commitUrl = `${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.pull_request.merge_commit_sha }}`;
            const repoName = context.repo.repo;
            const message = `üî® **Build started** for ${repoName}\n\n**Commit:** [\`${{ github.event.pull_request.merge_commit_sha }}\`](${commitUrl})\n**Workflow:** [View run details](${runUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Run the nori-bridge-head workflow, run integration tests and build images.
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
        run: |
          mkdir -p /tmp/stacksmith_repos
          stacksmith run bridge-head \
            --pr-number ${{ github.event.pull_request.number }} \
            --build-id "nori-bridge-head-${{ github.event.pull_request.number }}-${{ github.run_id }}-${{ github.run_number }}" \
            --target-branch build \
            --envs-dir /root/.stacksmith.envs \
            --working-dir /tmp/stacksmith_repos

      - name: Comment on PR - Build Complete
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.DISPATCH_TOKEN }}
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const commitUrl = `${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.pull_request.merge_commit_sha }}`;
            const repoName = context.repo.repo;
            let message;
            
            if ('${{ job.status }}' === 'success') {
              message = `‚úÖ **Build succeeded** for ${repoName}\n\n**Commit:** [\`${{ github.event.pull_request.merge_commit_sha }}\`](${commitUrl})\n**Workflow:** [View run details](${runUrl})`;
            } else {
              message = `‚ùå **Build failed** for ${repoName}\n\n**Commit:** [\`${{ github.event.pull_request.merge_commit_sha }}\`](${commitUrl})\n**Workflow:** Check the [workflow run](${runUrl}) for details.\n\n‚ö†Ô∏è Review the logs to identify the failure cause.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Cleanup stacksmith working dir
        if: always()
        run: |
          stacksmith cleanup --working-dir /tmp/stacksmith_repos
          echo "Cleanup completed"
